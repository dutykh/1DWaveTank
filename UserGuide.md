# 1DWaveTank: User Guide

**Author:** Dr. Denys Dutykh (Khalifa University of Science and Technology, Abu Dhabi, UAE)  
**Date:** April 20, 2025

## 1. Overview

`1DWaveTank` is a MATLAB-based numerical laboratory for simulating 1D long wave phenomena using the Finite Volume method. It provides a modular framework for experimenting with different numerical schemes, boundary conditions, and initial states for the **Non-Linear Shallow Water (NSW) equations**. The design prioritizes modularity, readability, and ease of extension, allowing users to readily test and integrate new components, even if this means sacrificing raw computational speed compared to highly optimized, monolithic codes.

The NSW equations solved here typically conserve mass and momentum, represented by the state variables:
* `H`: Water depth [m]
* `HU`: Discharge (or momentum) [mÂ²/s]

This document details the structure, components, and usage of the `1DWaveTank` code.

## 2. Project Structure

The code is organised into MATLAB packages for modularity:

- **`+cfg`**: Configuration files and functions
- **`+core`**: Core solver logic and RHS (Right-Hand Side) functions
- **`+flux`**: Numerical flux implementations for the finite volume method
- **`+bc`**: Boundary condition implementations
- **`+ic`**: Initial condition setups
- **`+bathy`**: Bathymetry functions
- **`+time`**: Time integration schemes
- **`+vis`**: Visualisation tools
- **`run_simulation.m`**: Main script to execute a simulation
- **`README.md`**: Project overview and basic setup guide

## 3. Getting Started

1. **Configure:** Edit `+cfg/simulation_config.m` to select an `experiment_setup` (e.g., `'flat_rest'`, `'flat_gaussian'`, `'flat_wave_gen'`) and customise parameters like domain, mesh size (`N`), end time (`tEnd`), numerical flux (`numFlux`), time stepper (`timeStepper`), boundary conditions (`bc.left.handle`, `bc.right.handle`), initial condition (`ic_handle`), etc.
2. **Run:** Execute the main script:
   ```matlab
   run_simulation
   ```
3. **Observe:** The script displays simulation progress and animates the results. The final output is stored in the `results` structure.

## 4. Configuration (`+cfg`)

Configuration controls the simulation setup hierarchically: Defaults -> Experiment Setup -> User Overrides.

### 4.1. `default_config.m`

- Provides baseline parameters and default function handles.
- Called first by `simulation_config.m`.

### 4.2. `simulation_config.m`

- Main configuration file.
- Loads defaults and applies scenario-specific overrides.
- Sets mesh, time stepping, physical model, output path, etc.
- **Example Override:**
  ```matlab
  % Inside simulation_config.m, after loading defaults/setup:
  switch experiment_setup
      case 'flat_gaussian'
          % ... other settings ...
          config.tEnd = 10.0; % Override default end time
          config.numFlux = @flux.LaxFriedrichs; % Choose Lax-Friedrichs flux
          config.ic_param.a = 0.1; % Set IC parameter
          config.bathyHandle = @bathy.flat_bathymetry; % Set flat bathymetry
          config.icHandle = @ic.solitary_wave; % Set solitary wave IC
          % ...
  ```

### 4.3. `+cfg/+bathy`

- **`flat_bathymetry.m`**: Implements flat bathymetry:
  ```matlab
  function h = flat_bathymetry(x, cfg)
  ```

## 5. Core Components (`+core`)

### 5.1. `solver.m`

- Main simulation orchestrator.
- Sets IC, selects RHS, calls time integrator, computes `H`, `HU`, `U`.
- Returns results with metadata.

### 5.2. `rhs_nsw_1st_order.m`

- Computes RHS using 1st order FV scheme.
- Applies BCs, computes numerical fluxes, handles source terms.
- **Well-Balancing Note:** The bed slope source term is currently commented out. For simulations with non-flat bathymetry (`cfg.bathyHandle` is not `@cfg.bathy.flat_bathymetry`), implementing a **well-balanced** scheme (either by modifying the flux or the source term calculation) is crucial. This ensures that steady states (like a lake at rest over a varying bottom) are correctly maintained and prevents spurious flows generated by numerical imbalance between flux gradients and source terms.

### 5.3. Core Utilities (`+core/+utils`)

- `calculate_dt_cfl.m`, `get_bc_style.m`, `get_param.m`, `odetpbar.m`, `physical_flux.m`, `struct2str.m`, `textprogressbar.m`, `uniform.m`.

## 6. Numerical Fluxes (`+flux`)

Implemented schemes:

- `AUSM+.m`  (AUSM+ variant)
- `AUSMDV.m` (AUSM-Derivative Variant)
- `FORCE.m`
- `FVCF.m`
- `HLL.m`
- `HLLC.m`
- `LF.m`
- `LaxFriedrichs.m`
- `OsherSolomon.m`
- `Roe.m`
- `Rusanov.m`
- `StegerWarming.m`

All take `(wL, wR, cfg)` and return `[Flux_H, Flux_HU]`.

## 7. Boundary Conditions (`+bc`)

Boundary conditions define how the simulation behaves at the edges of the domain (`xmin` and `xmax`). They are set using function handles in `cfg.bc.left.handle` and `cfg.bc.right.handle`.

*   **`@bc.wall`:** Simulates a solid, impermeable wall. This is the default condition. It sets the velocity (HU) to zero in the ghost cells and reflects the water height (H).
*   **`@bc.generating`:** Simulates a wave generation boundary. Currently configured for sinusoidal waves based on amplitude (`cfg.bc.left.param.a` or `cfg.bc.right.param.a`) and frequency (`cfg.bc.left.param.omega` or `cfg.bc.right.param.omega`).
*   **`@bc.periodic`:** Connects the left and right boundaries, treating the domain as if it wraps around. Values leaving one side enter the other. To use periodic conditions, *both* `cfg.bc.left.handle` and `cfg.bc.right.handle` must be set to `@bc.periodic`.

Example configuration for periodic BCs:
```matlab
cfg.bc.left.handle = @bc.periodic;
cfg.bc.right.handle = @bc.periodic;
```

## 8. Initial Conditions (`+ic`)

Initial condition functions:

- `gaussian_bump.m`: Gaussian water surface bump, zero velocity. Uses param.a, lambda, x0, H0.
- `lake_at_rest.m`: Constant water depth, zero velocity. Uses param.H0.
- `solitary_wave.m`: Solitary wave initial condition.

Signature:
```matlab
function w0 = ic_function(xc, cfg)
```

## 9. Bathymetry (`+bathy`)

Bathymetry functions:

- `flat_bathymetry.m`: Flat bathymetry.

## 10. Time Integration (`+time`)

### Custom Adaptive Steppers

- `integrate_ab2_adaptive.m`: 2nd-order Adams-Bashforth.
- `integrate_bogacki_shampine.m`: 3(2) embedded Runge-Kutta (Bogacki-Shampine).
- `integrate_euler_adaptive.m`: Forward Euler.
- `integrate_rk4_adaptive.m`: 4th-order Runge-Kutta.
- `integrate_ssp2_adaptive.m`: 2nd-order SSP Runge-Kutta.
- `integrate_ssp3_adaptive.m`: 3rd-order SSP Runge-Kutta.

All follow signature:
```matlab
function [sol_out, t_out, stats] = integrate_...(rhs_func, tspan, w0, cfg)
```

### MATLAB Solver Wrapper

- `integrate_matlab_ode.m`
- Uses `cfg.time.matlab_solver`, `AbsTol`, `RelTol`, `ode_options`
- Uses internal error control for time stepping (not CFL)

## 11. Visualisation (`+vis`)

### `plot_state.m`

- Plots water surface and bathymetry.
- Optionally plots velocity.
- Handles figure updating and axis management.
- Used by `run_simulation.m` for animation.

## 12. Main Script (`run_simulation.m`)

- Clears environment, adds paths.
- Loads config and runs the simulation.
- Calls visualisation tools.
- Prints CPU time and global statistics.

## 13. Requirements

- MATLAB (developed and tested on recent versions, e.g., R2020a and later, but may work on older versions).
- No specific toolboxes are required for the core functionality.

## 14. Extensibility

The modular structure using MATLAB packages makes it easy to add new components, aligning with the project's goal of providing a clear and adaptable framework for numerical experimentation:

- **New Flux:** Add a function to `+flux/`, e.g., `F = my_flux(wL, wR, cfg)` and select via `cfg.numFlux = @flux.my_flux;`.
- **New BC:** Add a function to `+bc/`, e.g., `w_padded = my_bc(w_padded, t, side, cfg, num_ghost_cells)` and use `cfg.bc.left.handle = @bc.my_bc;`.
- **New IC:** Add a function to `+ic/`, e.g., `w0 = my_ic(xc, cfg)` and use `cfg.icHandle = @ic.my_ic;`.
- **New Time Stepper:** Add a function to `+time/`, e.g., `integrate_my_scheme`, and use `cfg.timeStepper = @time.integrate_my_scheme;`.
- **New Bathymetry:** Add a function to `+cfg/+bathy/`, e.g., `h = my_bathy(x, cfg)` and use `cfg.bathyHandle = @cfg.bathy.my_bathy;`. Ensure well-balanced scheme support for non-flat beds.

### Available Experiment Setups

The `+cfg/simulation_config.m` script allows selecting pre-defined experiment setups by changing the `experiment_setup` variable.

*   **`'flat_rest'`:** Flat bathymetry, water initially at rest (`h0`). Wall boundaries.
*   **`'flat_gaussian'`:** Flat bathymetry, Gaussian pulse initial condition. Wall boundaries.
*   **`'flat_wave_gen'`:** Flat bathymetry, generating boundary on the left, wall on the right.
*   **`'flat_solitary'`:** Flat bathymetry, solitary wave initial condition. Wall boundaries.
*   **`'periodic_solitary'`:** Flat bathymetry, solitary wave initial condition. Periodic boundaries on both left and right.

Each case sets the appropriate `bathyHandle`, `icHandle`, and `bc` handles, and defines a descriptive `case_name` for output files.